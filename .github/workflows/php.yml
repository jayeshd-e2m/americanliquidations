name: Tailwind CSS Build and Deploy

on:
  push:
    branches:
      - main  
    paths:
      - "themes/**"  

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install Dependencies
        run: | 
            cd ./themes/american-liquidations
            npm install

      - name: Install Tailwind CSS
        run: |
            cd ./themes/american-liquidations
            npm install -g tailwindcss

      - name: Compile Tailwind CSS
        run: |
            cd ./themes/american-liquidations 
            npx tailwindcss -i ./assets/src/input.css -o ./assets/dist/output.css --minify

      - name: Install rsync and sshpass
        run: |
          sudo apt-get install -y rsync sshpass

      - name: Upload Compiled CSS via SFTP
        env:
          SFTP_USER: ${{ secrets.SFTP_USER }}
          SFTP_PASS: ${{ secrets.SFTP_PASS }}
          SFTP_HOST: ${{ secrets.SFTP_HOST }}
          SFTP_PORT: ${{ secrets.SFTP_PORT || 22 }}
        run: |
          set -e  # Exit on error
          echo "Uploading compiled Tailwind CSS..."
          
          # Disable host key checking to avoid the verification failure
          export SSHPASS="$SFTP_PASS"
          sshpass -p "$SFTP_PASS" rsync -avz -e "ssh -o StrictHostKeyChecking=no -p $SFTP_PORT" \
            ./themes/american-liquidations/ \
            $SFTP_USER@$SFTP_HOST:/home/755960.cloudwaysapps.com/jwcjubqamu/public_html/wp-content/themes/american-liquidations/

          echo "Upload completed successfully!"
